# Li-Ion-UPS-18650
Describe how to create simple, cheap and efficient UPS, based on 18650 Li-Ion batteris

Традиційні ББЖ/UPS досить ефективні коли мова йде за навантаження більше 100Вт і які потребують для своєї роботи 220в. Якщо ж мова йде за невеликі навантаження які в свою чергу оснащені БЖ на 5/9/12в, то наяність перетворювачів з 6/12 DC в 220 AC (частина UPS) і потім 220 AC в 5/9/12 DC (БЖ присторою) виглядає надлишковою. Опишу мої потугі щоб створити міні блок безперервного живлення (ББЖ) на базі Li-Ion 18650 акумуляторів які би одночасно заряджались і живили присторої на 5/9/12 В.

### Задача #1

#### YI Home Camera

Є IP-камера відеоспостереження YI Home Camera 1080p. Є запис на MicroSD карточку.

Камера живиться по Micro USB. В комплекті іде БЖ з виходом 5В і 1А.

Стандартне споживання ~250mA. В нічному режимі із-за інфрачервоного підсвічування струм зростає до ~400mA.

Забезпечити можливість автономної роботи Wi-Fi камери.

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/YiHome-photo.jpg) 


 

### Версія #0.0

#### Контроллер TP4056 Для Li-Ion

Першим в руки попав контроллер для Li-Ion на базі TP4056.

Має вхід для 5В через Micro USB або можна найти версію з контактами на платі.

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/TP4056-photo.jpg)

Cons: Відсутній захист від перезаряду і перерозряду батареї. Треба окремо BMS модуль для захисту батареї. Непередбачено одночасне підєднання навантаження і батареї. Використання можливе лише в варіанті CC/CD зарядного.

На тому експеременти з тим модулем завершились.



 
### Версія #0.1

#### Контроллер TP4056+DW01 Для Li-Ion

Для наступного експеременту пішла більш просунута версія Li-Ion контролера на базі TP4056 яка вже має модуль захисту батареї реалізований на чіпі DW01.

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/TP4056-DW01-photo.jpg) 

Чомусь помилково вирішив що даний модуль є завершеним рішенням і на виході дає 5В. 

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/TP4056-DW01-schema.jpg)

Cons: На виході нема 5В. Отже, на вході 5В, на батареї напруга від <3 до 4,2в залежно від заряду батареї, на виході то саме що і на батареї. Батарея була заряджена і камера стартанула і працювала від ~4В. Напруга на виході не 5В.




### Версія #0.2

#### Контроллер TP4056+DW01 і MT3608

Отже для фіксання вихідної напруги контроллера TP4056+DW01 щоб на виході було 5В треба DC-DC StepUp. Під руками був лише регульований на базі MT3608.

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/MT3608-photo.jpg)

До речі получилось рішення дуже подібне до того що описано в https://habr.com/ru/post/444076/

Досить адекватне рішення. Залишилось зібрати і протестувати, чи зможе це бути заміною UPS чи лише як повербанк рішення. Отже схема виглядає такою:

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/TP4056-DW01-MT3608-schema.jpg)

#### Вольтамперметр

Трошки відступу. Для того щоб зібрати інфу про детальну поведінку схеми треба періодично міряти струм і напругу у всіх точках схеми. Прбував використовувати мультиметр(и). Якщо напругу в якійсь точці ще можна міряти періодично мультиметром, то зі струмом проблематично, бо мультиметр сам вирубається що 15 хв. З найдешевшого в китайців був оцей вольтамперметр постійного струму.

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/VA.jpg)

Найшов в україні не набагато дорожче ніж в китайців. І варіант з Києва на завтра переміг варіант з Китаю за місяць (або два) хоча і був дорожчий на пару центів. Ще би Нова Пошта трохи менше дерла, можна би було взагалі з Китаю не замовляти. Так от чотири таких девайса запхано в кожну гілку, для моніторинга.

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/TP4056-DW01-MT3608-VA-schema.jpg)

Cons: Дані модулі мають два варіанта підключення: з живленням від вимірюваної напруги і з зовнішнім живленням. В першому варіанті проблема що напруга має бути >4В (в реальності десь 3.0-3.2В), бо інакше маєм потухший екран. А при схемі з зовнішнім живленням вилізла бага. Я всі ВАметри підключив до одного БЖ на 9В, тобто у всіх виявились зєднані +/- живлення і це мало наслідки. Один з ВАметрів не показував струм. Другий нюанс з тими девайсами - вони показують лише струм з полярністю відповідною підключенню. Це не дуже добре для гілки з батареєю. Коли батарея заряжається струм заряду відображається, коли розряд батареї показує 0А.

#### Тестування

Для тестування був використаний якийсь нонейм Li-Ion акумулятор але з перевіреною ємністю 2500мАг. Батарея була заряджена повністю за допомогою зовнішнього зарядного. Тестування проводив вдень, тобто струм споживання камери 250мА. 

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/TP4056-DW01-MT3608-VA-test.jpg)

Відєднуєм вхідне живлення і ждем. Рівно 7 годин заняло щоб акумулятор розрядився з 4.2В до 3.0В. А далі напруга з 3.0В впала до 2.5В буквально за 2-3хв. При 2.5В  контролер відрубав навантаження. Напруга на акумуляторі почала підніматись. Коли вона відновилась до 2.9-3.0В контролер знову врубав навантаження і тим самим ще більше розрядив акум. Наступний раз відновлення напруги на акумі тривало 20хв....І так було 3 рази. Акум став досить посаджений, для його здоров'я це згубно. 

Відновлюєм вхідне живлення. Поведінка контролера виглядає логічною і передбачає, що акумулятори розряджені нижче ніж 3В треба початково заряджати невеликим постійним струмом 100мА до напруги 3В, а далі по схемі CC 1А і потім CD 4.2В. А тепер веселе. Акум повністю розряжений до 2.5-2.6В, контролер в режимі "розкачування" акума і має подавати 100мА на батарею, а він лімітує вхідне споживання від мережі 100мА і подає їх одночасно і на батарею і на навантаження!!! Наслідок, камері 100мА для роботи мало, вона не може нормально стартанути, на батарею нічого не лишається, навіть гріше камера забирає з батареї все що там ще лишилось, напруга на акумі падає, на 2.4В мені стало шкода акумулятора і я відєднав навантаження. Без навантаження, акумулятори досить швидко дозарядились до 3В і контролер почав замість 100мА давати повноцінний 1А. Без навантаження контролер зарадить акумулятор без проблем, але ж у нас UPS і цікавить поведінка в цьому режимі. Коли струм став 1А підключаєм знову камеру. Плата дико гріється до 85-90С, споживає рівно 1А і його ділить, 250мА на камеру і 750мА на батарею. Це десь нагадує CC режим зарядки, струмом 750мА. При 4.2В на батареї починає падати струм до нуля. Але LED що вказує що зарядка завершилась ніколи не засвічується, це вказує, що контролер перевіряє струми споживання, а не струм в гілці зарядки батареї.

Pros: Хоть якось працює. Все би було добре якби напруга на батареї не опускалась нижче 3В. 

Cons: Якщо довго нема живлення то в смерть розряжається акумулятор і при відновленні живлення невдається зарядити акумулятор.




### Версія #0.3

#### Контроллер TP4056+DW01 і MT3608 і Релє

Фіксаєм ішуси з попередньої схеми. Трохи погуглявши попало таке рішення https://ovcher.com/pitanie/prostoj-bbp.html Виглядає досить логічно. Переробляти по мінімуму - доліпити релюшку. Що насторожує вже це питання чи коректно рубане акум при досягненні нижньої межі. І друге це виглядає що струм заряду буде 1А і камера 250-400мА додатково, отже існуючий БЖ на 1А не стягне. 

#### Тестування

Схема зібрана, погнали. Цього разу не було бажання чекати 7 годин тому знайшов акумулятор від ліхтарика. Там виявився супереконом версія - 700 мАг. Батарею до повного заряджав схемою. З приємного - це батарея зарядилась і загорівся синій LED, що значить зарядка завершилась. Тестування проводив вдень, тобто струм споживання камери 250мА. Перше що вилізло це струм споживання, релюшка зжирала десь 150-180мА!!! 

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/TP4056-DW01-MT3608-VA-Relay-test.jpg)

І наступне, що вилізло також відразу - камера ішла в ребут при імітації пропадання/відновлення живлення. Причому що при виключенні вхідної напруги, що при відновленні. Тут пояснення поки нема, все ж таки по даташитах час спрацьовування релє дуже маленький.

Цього разу все відбулось за півтора години. Ще через 2 хв напруга впала до 2.5В і система відрубалась. А далі попередня проблема. Напруга досить швидко повертається до 2.9В і включається подача напруги на камеру. Камера стартує на 2-4 сек, навіть не встигає стартанути і акумулятор знову розряжається в 2.5В. Протягом 10хв це відбулось десь 15 разів і мені стало шкода камеру, незнаю чи шкодить чи ні такі дії камері. Як ці "качелі" виглядають є на відео https://youtu.be/TlYVMBAlbn4

Відновлення живлення. Камера класично ребутнулась. В той же час батарея підзарядилась 100мА током і після 3В перейшла в режим зарядки СС 1А. Як і передбачалось - споживання 1.4А. На акумулятор 1А, решта на камеру і релюшку. TP4506 як і раніше >70C. MT3608 холодна (бо протікає 250мА при декларованих 2А). Була думка замінити резистор відповідальний за струм заряду, щоб сумарний струм не перевищував 1А, але нема сенсу це робити при існуючих недоліках.

Не впевнений що з цього рішення можна витисснути ще щось більше, що би працювало адекватно. Хіба кого влаштовує то миритись з тими кейсами якщо не критично.




### Версія #0.4

#### Контроллер MH-CD42

Ще один цікавий варіант на базі MH-CD42. Не знаю з чим повязано але досить мало інфи по цій схемі. Досить не дорогий, навіть в україні ціна менше 2 доларів. Шо сподобалось - все на одній платі (навіть на одній мікросхемі): BMS і Upstep, ше і в додаток 4 LED для індикації рівня зяряду і кнопка вкл/викл. 

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/MH-CD42-photo.jpg)

#### Тестування

Зібрати схему - реально 5 хв якщо все підрукою. Почав з супереконом акумулятора на 700 мАг. Система прожила як і в попередньому варіанті 1.5 год знову, заряд не тестував бо не хотів заряжати акумулятор струмом 1.5А - 1.8А що є 2-2.5С. Все що далі описано проводилось на акумуляторі 2500 мАг. Акумулятор повністю заряжений зовнішньою зарядкою. Всі 4 LED світяться і сигналізують про повний заряд батареї. Поїхали - power off. І перший недолік. камера пішла в ребут. Пізніше по доках знайшов що при переході на батарею іде пропадання напруги на виході на 0.3 сек. Цього досить щоб камера ребутнулась. З камерою на це можна закрити очі а от з Raspberry це не пройде. При відновленні живлення все йде поплану, нічо не вирубається. Тестування проводив вдень, тобто струм споживання камери 250мА. Система як і при попередніх експерементах прожила трохи більше 7 год. Сподобалось що акумулятор відрубався на напрузі 3.1 В, а не висаджувався без толку до 2.5В (з 3.1 В до 2.5 В це буквально 1-2 хв). Другий позитивний момент що нема ефекту "качель" - тобто підняття напруги на акумуляторі (при відсутності вхідної напруги) не призвело до включення навантаження. Навіть заміна на повністю заряджений акумулятор не призвела до старта. Але для цього на платі є кнопка якою можна примусово включити навантаження в режимі розрядки.

Відновлюєм вхідне живленняя. Струм споживання до 2А, на акумулятор іде мінус струм навантаження = 1,5А). Плата не гаряча - несь 40-50С. Досить швидко (менше години) акумулятор заряжається більш менш сталим струмом 1,5А до напруги 4 В (CC частина процесу, хоча цей процес мав би йти до напруги 4.2 В) а далі мала би йти класична CV частина з сталою напругою і зменшенням струму. А в цій платі це трошки мало відхилення, струм падав з 1,5А до 0А а напруга росла з 4В до 4.1 В струм. Відключення системи заряду відбулось на 4,1В. Підозрюю що недозарядилась батарея. Досить великий струм заряду дозволяє включити паралельно дві батареї з сумарною ємністю 5000-6000 мАг.

Cons: Якщо недозаряд акумулятора можна проігнорувати то вимкнення навантаження при переході на батарею незавжди. Для вирішення спробува приліпити на вихід кондюк, ні 100 ні 1000 мкФ не поміг. І друге це струм споживання буде 2А отже існуючий БЖ на 1А не стягне, треба купляти сторонній. 

PS: Замість конденсатора можна спробувати іоністор (суперконденсатор). Щось приблизно описане в https://mysku.ru/blog/ebay/35184.html Десь там і формула (дуже спрощена) проскакувала розрахунку ємності акумулятора. Отже що треба: 5В 0.5А 0.3сек = 0.75Дж. Енергія конденсатора = ємність * напруга * напруга. Або при розряді від 5В до 4В буде витрачено енергії = єиність * (5В^2 - 4В^2). Отже ємність іоністора достатньо 0.1 Фарад. 




### Версія #0.5

#### Контроллер UPS 12v

Ще один цікавий варіант готового UPS модуля на 12в (є версія на 9в). Деяка інформація про принцип функціонування знайшов https://mysku.ru/blog/taobao/72616.html Хоча на моїй платі маркування мікросхем затерті, і назви неможливо ідентифікувати. Досить не дорогий, ціна в Китаї менше 2 доларів, в Україні нажаль не знайшов. Аналогічно до MH-CD42 все на одній платі: BMS і Upstep, ше і є місце для LED що є індикатором роботи і заряду батареї. 

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/UPS-12v-photo.jpg)

#### Тестування

Схему досить проста для збору, прийшлось допаяти два світлодіоди. І працюють трохи інакше ніж в описі - червоний блимає - нема батареї; червоний горить - іде заряд; синій горить - підключено навантаження, при відєднаному навантаженні не світить. Оскільки готовий модуль на виході дає 12В (якщо розімкнути JP1 то буде 9В) тому прийшлось ще додавати StepDown LM2596, щоб було 5В. Якось система дивно себе вела, чомусь в один момент акумулятор був розряджений, прийдеться детальніше поковиряти. Отже подаєм живлення (використовував на вхід 9В) на модуль без батареї і без навантаження - червоний LED блимає. Підєднуєм батарею - червоний LED стабільно горить і сигналізує про заряд. Підєднав навантаження - загорівся синій LED. Батарея мала би бути заряджена з попередніх експериментів. Але для гарантії чекав 2 години. Напруга на батареї зросла до 4.19В але LED червоний не потух, може недочекався.

При відключенні вхідного живлення не відбувалось ребуту камери. Чи КПД мале чи недозаряджена батарея але непрожила система і 5 годин. Десь в районі 3 вольт на батареї відбулось відключення. А тепер цікаве! При відновленні живлення на виході плати було 8.9В, підозрюю специфіку роботи, не забуваєм що на вході БЖ з 9.2В. Протестую з БЖ на 12В, подивимось. Хоча згідно інструкції на вході може бути 6-12В. Трішки підзарядив акумулятор до 3.5В і відключив. Ще більш несподіваний результат. На виході плати 4.8В, і відповідно на виході LM2596 ще менше 4.0В. Хоча камера працює від 4В, але це ненормально. Дубль два - підзарядився акумулятор до 3,5В, відключаєм вхід, добре що камера не ребутається, але на виході плати знову 5В і на батареї напруга просіла до 3.4В. Відновлюю живлення - і оп камера в ребут, видно 4В на виході понижуючого модуля замало для камери щоб адекватно пережити переключення на вхідне живлення. Залишив в такому стані на ніч. Несподіванки продовжуються. Через 8 годин напруга на акумуляторі 3.75В, на виході плати вже 8.8В, а червоний світлодіод мигає але з набагато нижчою частотою ніж при відсутності батареї (десь 1-2 сек період), склалось враження що в момент коли світить заряжає, а коли потухший то бере з батареї. Спробувував вимкнути вхідну напругу (камера ребутнулась) і через пару секунд відновити і вуаля - на виході плати 12В, червоний лед горить, напруга на батареї зростає.

#### Тестування - дубль два

Експеремент розпочався з зарядки батареї. На початку експеременту на батареї було 3.6В, зарадка іде - напруга на батареї зростає червоний LED горить. На вході в плату 9.2В і струм споживання 300мА. На виході плати на DC-DC StepDown іде 12.2В і 100мА, ну і на камеру 5.1В і 220мА. Через 12 год - лед горить що значить батарея ще не заряджена, хоча напруга на батареї вже 4.19В. На вході 9.2В і 300мА як і було на початку. На виході також без змін 12В і 100мА. 24 години ситуація без змін. Через 36 год маєм сюрприз. Батарея розряжена - 3.08В, на виході плати 8.8В, струм від БЖ впав з 300мА до 200мА, червоний LED блимає з частотою 0.5Гц. Як це виглядає https://youtu.be/963-Z8T_fgI Нема сенсу продовжувати тестування при цих умовах. Розчарував мене модуль, хоча не відкидаю браку. Чекаю ще одну таку саму плату. Спробую ще тест на БЖ 12В

#### Тестування - дубль три

Для тесту змінив БЖ. Тепер на вхід плати замість 9В буду подавати 12В. Надіюсь будуть зміни, хоча згідно запевнень кітайців плата має одинаково працювати в діапазоні вхідних напруг 6-12В. Отже на початку тесту - батарея 3.08В, вхід плати 12.5В і 350мА, вихід плати 12.2В і 110мА і на камеру іде 5.1В і 220мА. І перша позитивна зміна. Через 8 годин червоний LED потух, що свідчить що зарядка завершена. Після завершення зарядки - на вході плати 12.5В і споживання 150мА, вихід плати 12.2В і 110мА, на камеру 5.1В і 210мА, на батареї 4.15В (трохи недозаряд)

Вимикаєм живлення. Перехід на камеру відбувся без ребута камери. Відразу ж напруга на батареї просіла з 4.15В до 4.04В. Виглядає на серйозний недозаряд батареї. Розряд ішов лінійно, напруга на батареї рівномірно падала з кроком 0.15В - 0.1В / 30 хв. Через 4 години на батареї залишалось 3,23В і на виході плати все ще було 12.6В і струм 100мА і камера ще працювала. За наступні 10-15 хв напруга на батареї просіла до 3.1В - 3.15В і в результаті плата почала на виході давати 4В і показувала струм віддачі 70мА, на виході LM2596 і того менше, LED на камері світився, але вона не реагувала. Ще 15-20 хв коли напруга на батареї опустилась до 3.04В плата повністю відключилась.

Pros: При переході на батарею не було перегрузки камери. Індикатор повного заряду спрацював. Можна окремо розглянути для 12В пристроїв.

Cons: Більш менш адекватно вела себе лише при 12В на вході. Недозаряд батареї, робота 4год замість 7 год. Потреба в DC-DC StepDown.




### Версія #0.6

#### Модуль UPS 5v на базі 4056

Наступний клієнт на тестування. Готовий UPS модуль на 5в (є версії на 6, 9, 12в). Деяка інформація про модуль є https://ovcher.com/pitanie/bbp-alternativa.html Досить не дорогий, ціна в Китаї менше 2 доларів, цей що тестую брав в україні десь по ціні 4 долари. Кітайці на своїх сайтах малюють зразу підключення до батареї, хоча насправді для батареї потрібен BMS. Upstep є на платі. Є LEDи для індикації роботи і заряду батареї. 

![](https://github.com/abajavascript/Li-Ion-UPS-18650/blob/master/UPS-4056-5V-photo.jpg)

#### Тестування

Схему досить проста для збору, прийшлось допаяти два світлодіоди. І працюють трохи інакше ніж в описі - червоний блимає - нема батареї; червоний горить - іде заряд; синій горить - підключено навантаження, при відєднаному навантаженні не світить. Оскільки готовий модуль на 



